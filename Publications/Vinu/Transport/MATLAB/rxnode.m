% Cellulose reactions - not causing much problems : T spike observed
% HCE and Lignin reactions : Both are causing problems : T spike observed
% The following reactions show no T spike : 3,4,7,8,9,10,13,15,17,18,19,20
% The following show T spikes : 2,5,6,12,14
% The following reaction failed : 11,21
% Spike around 12000 K : 16


function dT = rxnode(t,T)

n = 20;
p = n+1;
k = 0.04;       % Thermal conductivity

height = 1;
Length = 1;   
Width = 1;
dVol = (height*Length*Width)/(n-1);
spacing = height/(n-1);  
A = Length*Width;

Va  = 1;       % Velocity of air
nu =  2*10^-5; % Kinematic viscosity of air
phi = 0.6;     % Packing fraction of bed

Re = Va*Width/(nu*(1-phi));
Nu = 2 + 0.9*sqrt(Re) ;

h = Nu*k/Width;
% h = h/1000    % To be consistent with the units
%h = 0.5;
rho = 800;
Cp = 1500;
sigma = 5.67*10^-8;
e = 0.8;


dT = zeros(40*(n+1),1);

for j = 0:(n-1)
    
    heat = zeros(1,23);
    
    

heat(2) = 650000*T(2+40*j);
heat(3) = 490000*T(2+40*j);  
heat(4) = -1800000*T(1+40*j);
% heat(5) = 100000*T(3+40*j); % HCE
% heat(6) = 22000*T(4+40*j);
% heat(7) = -1400000*T(4+40*j);
% heat(8) = 590000*T(4+40*j);
% heat(9) = -330000*T(5+40*j); % HCE
% heat(10) = -100000*T(6+40*j);
% heat(11) = 130000*T(7+40*j);
% heat(12) = 260000*T(8+40*j);
% heat(13) = -450000*T(9+40*j);
% heat(14) = 70000*T(10+40*j);
% heat(15) = -1300000*T(10+40*j);
% heat(16) = 890000*T(11+40*j);
% heat(17) = -300000*T(11+40*j);
% heat(18) = -1770000*T(11+40*j);
% heat(19) = -860000*T(33+40*j);
% heat(20) = -1500000*T(29+40*j);
% heat(21) = 6800000*T(30+40*j);
    
heat= heat.*rho;

f=zeros(23,1);
f(1)=8*(10^13)*exp(-45000*4.18/(8.314*T(40 +40*j)));
f(2)=(10^9)*exp(-30000*4.18/(8.314*T(40+40*j)));
f(4)=8*(10^7)*exp(-31000*4.18/(8.314*T(40+40*j)));
f(3)=4*T(40+40*j)*exp(-10000*4.18/(8.314*T(40+40*j)));
f(5)=(10^10)*exp(-31000*4.18/(8.314*T(40+40*j)));
f(6)=3*(10^9)*exp(-32000*4.18/(8.314*T(40+40*j)));
f(7)=0.15*T(40+40*j)*exp(-8000*4.18/(8.314*T(40+40*j)));
f(8)=3*T(40+40*j)*exp(-11000*4.18/(8.314*T(40+40*j)));
f(9)=(10^10)*exp(-33000*4.18/(8.314*T(40+40*j)));
f(10)=4*(10^15)*exp(-48500*4.18/(8.314*T(40+40*j)));
f(11)=2*(10^13)*exp(-37500*4.18/(8.314*T(40+40*j)));
f(12)=(10^9)*exp(-25500*4.18/(8.314*T(40+40*j)));
f(13)=5*(10^6)*exp(-31500*4.18/(8.314*T(40+40*j)));
f(14)=3*(10^8)*exp(-30000*4.18/(8.314*T(40+40*j)));
f(15)=(10^2)*exp(-15000*4.18/(8.314*T(40+40*j)));
f(16)=8*T(40+40*j)*exp(-12000*4.18/(8.314*T(40+40*j)));
f(17)=1.2*(10^9)*exp(-30000*4.18/(8.314*T(40+40*j)));
f(18)=0.25*T(40+40*j)*exp(-8000*4.18/(8.314*T(40+40*j)));
f(19)=6*(10^5)*exp(-24000*4.18/(8.314*T(40+40*j)));
f(20)=5*(10^11)*exp(-50000*4.18/(8.314*T(40+40*j)));
f(21)=5*(10^11)*exp(-71000*4.18/(8.314*T(40+40*j)));
f(22)=5*(10^11)*exp(-75000*4.18/(8.314*T(40+40*j)));
f(23)=5*(10^12)*exp(-50000*4.18/(8.314*T(40+40*j)));

b=1;
dT(1+40*j)= (-1)*(f(1)*T(1+40*j)+f(4)*T(1+40*j));
dT(2+40*j)= b*(f(1)*T(1+40*j))-f(2)*T(2+40*j)-f(3)*T(2+40*j);
dT(3+40*j)= (-1)*(f(5)*T(3+40*j));
dT(4+40*j)= b*(0.4*f(5)*T(3+40*j)-(f(6)+f(7)+f(8))*T(4+40*j));
dT(5+40*j)= 0.6*f(5)*T(3+40*j)-f(9)*T(5+40*j);
dT(6+40*j)= -f(10)*T(6+40*j);
dT(7+40*j)= -f(11)*T(7+40*j);
dT(8+40*j)= -f(12)*T(8+40*j);
dT(9+40*j)= -f(13)*T(9+40*j)+f(10)*T(6+40*j);
dT(10+40*j)= f(11)*T(7+40*j)+f(12)*T(8+40*j)-(f(14)+f(15))*T(10+40*j);
dT(11+40*j)= f(14)*T(10+40*j)-(f(14)+f(15)+f(16))*T(11+40*j);
dT(12+40*j)= 0.61*f(2)*T(2+40*j)+6*f(4)*T(1+40*j)+0.875*f(6)*T(4+40*j)+0.675*f(7)*T(4+40*j)+f(9)*T(5+40*j)+5.735*f(10)*T(6+40*j)+6.75*f(13)*T(9+40*j)+4.15*f(14)*T(10+40*j)+10.15*f(15)*T(10+40*j)+5.5*f(17)*T(11+40*j)+6*f(18)*T(11+40*j);
dT(13+40*j)= 0.83*f(2)*T(2+40*j)+5*f(4)*T(1+40*j)+0.025*f(6)*T(4+40*j)+0.25*f(7)*T(4+40*j)+0.2*f(9)*T(5+40*j)+f(10)*T(6+40*j)+0.7*f(13)*T(9+40*j)+0.9*f(14)*T(10+40*j)+1.5*f(15)*T(10+40*j)+0.95*f(17)*T(11+40*j)+0.6*f(18)*T(11+40*j);
dT(14+40*j)= 0.16*f(2)*T(2+40*j)+1.1*f(6)*T(4+40*j)+0.7*f(7)*T(4+40*j)+0.2*f(9)*T(5+40*j)+0.32*f(10)*T(6+40*j)+0.4*f(13)*T(9+40*j)+0.3*f(14)*T(10+40*j)+f(17)*T(11+40*j)+0.4*f(18)*T(11+40*j)+f(20)*T(29+40*j)+f(21)*T(30+40*j);
dT(15+40*j)= 0.22*f(2)*T(2+40*j)+1.075*f(6)*T(4+40*j)+0.75*f(7)*T(4+40*j)+0.425*f(9)*T(5+40*j)+f(12)*T(8+40*j)+0.05*f(14)*T(10+40*j)+0.5*f(15)*T(10+40*j)+f(19)*T(33+40*j)+0.4*f(18)*T(11+40*j);
dT(16+40*j)= f(21)*T(30+40*j)+f(22)*T(27+40*j);
dT(17+40*j)= 0.1*f(2)*T(2+40*j)+0.625*f(6)*T(4+40*j)+0.495*f(10)*T(6+40*j)+f(23)*T(31+40*j);
dT(18+40*j)= f(3)*T(2+40*j);
dT(19+40*j)= 0.08*f(10)*T(6+40*j)+0.2*f(13)*T(9+40*j);
dT(20+40*j)= 0.1*f(10)*T(6+40*j)+0.3*f(13)*T(9+40*j);
dT(21+40*j)= f(2)*T(2+40*j)+0.2*f(9)*T(5+40*j)+0.35*f(13)*T(9+40*j);
dT(22+40*j)= 0.2*f(2)*T(2+40*j);
dT(23+40*j)= 0.2*f(2)*T(2+40*j)+0.2*f(17)*T(11+40*j);
dT(24+40*j)= 0.25*f(2)*T(2+40*j);
dT(25+40*j)= 0.2*f(2)*T(2+40*j)+0.2*f(17)*T(11+40*j)+f(11)*T(7+40*j);
dT(26+40*j)= 0.01*f(2)*T(2+40*j)+0.025*f(6)*T(4+40*j)+0.05*f(7)*T(4+40*j)+0.025*f(9)*T(5+40*j)+0.05*f(14)*T(10+40*j)+0.05*f(17)*T(11+40*j);
dT(27+40*j)= 0.01*f(2)*T(2+40*j)+1.025*f(6)*T(4+40*j)+0.4*f(7)*T(4+40*j)+0.325*f(9)*T(5+40*j)+0.15*f(14)*T(10+40*j)+1.3*f(15)*T(10+40*j)+0.4*f(18)*T(11+40*j)-f(22)*T(27+40*j);
dT(28+40*j)= 0.25*f(6)*T(4+40*j)+0.5*f(14)*T(10+40*j)-f(23)*T(28+40*j);
dT(29+40*j)= 0.15*f(7)*T(4+40*j)+0.4*f(13)*T(9+40*j)+f(14)*T(10+40*j)+1.6*f(15)*T(10+40*j)+0.45*f(17)*T(11+40*j)+0.2*f(18)*T(11+40*j)-f(20)*T(29+40*j);
dT(30+40*j)= 1.3*f(7)*T(4+40*j)+f(9)*T(5+40*j)+f(10)*T(6+40*j)+f(13)*T(9+40*j)+0.6*f(14)*T(10+40*j)+3.9*f(15)*T(10+40*j)+0.5*f(17)*T(11+40*j)+2*f(18)*T(11+40*j)-f(21)*T(30+40*j);
dT(31+40*j)= 0.625*f(7)*T(4+40*j)+0.55*f(9)*T(5+40*j)+0.65*f(13)*T(9+40*j)+0.15*f(14)*T(10+40*j)+1.45*f(15)*T(10+40*j)+0.6*f(17)*T(11+40*j)+0.4*f(18)*T(11+40*j)-f(23)*T(31+40*j);
dT(32+40*j)= 0.375*f(7)*T(4+40*j)+0.275*f(9)*T(5+40*j)+0.6*f(13)*T(9+40*j)+0.2*f(14)*T(10+40*j)+0.65*f(17)*T(11+40*j)+0.5*f(18)*T(11+40*j)-f(23)*T(32+40*j);
dT(33+40*j)= 0.55*f(9)*T(5+40*j)-f(19)*T(33+40*j);
dT(34+40*j)= f(8)*T(4+40*j);
dT(35+40*j)= 0.3*f(6)*T(4+40*j)+0.1*f(9)*T(5+40*j)+0.2*f(17)*T(11+40*j);
dT(36+40*j)= 0.125*f(6)*T(4+40*j)+0.1*f(9)*T(5+40*j);
dT(37+40*j)= 0.25*f(6)*T(4+40*j)+0.41*f(10)*T(6+40*j)+0.7*f(15)*T(10+40*j)-f(23)*T(37+40*j);
dT(38+40*j)= 0.5*f(14)*T(10+40*j)+0.4*f(17)*T(11+40*j)+f(23)*T(28+40*j);
dT(39+40*j)= f(16)*T(11+40*j);


if eq(j,0)
    continue
end

% rho = T(40*j + 1) + T(40*j+2)+ T(40*j+3)+ T(40*j+4)+ T(40*j+5)+ T(40*j+6)+ T(40*j+7)+ T(40*j+8)+ T(40*j+9)+ T(40*j+10)+ T(40*j+11) + T(40*j+18);
dT(40+40*j)= (1/rho*Cp*dVol)*(-h*(T(40+40*j) - T(40 + 40*(j+1))) + 0.5*sigma*e*(T(40+40*(j-1))^4 +T(40+40*(j+1))^4 - 2*T(40+40*j)^4)  + (heat*f)/(1) );

% Heat Balance Eqn: mCp del T = q*V

end

 heat = zeros(1,23);
    
   j =0; 

heat(2) = 650000*T(2+40*j);
heat(3) = 490000*T(2+40*j);
heat(4) = -1800000*T(1+40*j);
% heat(5) = 100000*T(3+40*j); % HCE
% heat(6) = 22000*T(4+40*j);
% heat(7) = -1400000*T(4+40*j);
% heat(8) = 590000*T(4+40*j);
% heat(9) = -330000*T(5+40*j); %HCE
% heat(10) = -100000*T(6+40*j);
% heat(11) = 130000*T(7+40*j);
% heat(12) = 260000*T(8+40*j);
% heat(13) = -450000*T(9+40*j);
% heat(14) = 70000*T(10+40*j);
% heat(15) = -1300000*T(10+40*j);
% heat(16) = 890000*T(11+40*j);
% heat(17) = -300000*T(11+40*j);
% heat(18) = -1770000*T(11+40*j);
% heat(19) = -860000*T(33+40*j);
% heat(20) = -1500000*T(29+40*j);
% heat(21) = 6800000*T(30+40*j);

heat = heat.*rho;

f=zeros(23,1);
f(1)=8*(10^13)*exp(-45000*4.18/(8.314*T(40 +40*j)));
f(2)=(10^9)*exp(-30000*4.18/(8.314*T(40+40*j)));
f(4)=8*(10^7)*exp(-31000*4.18/(8.314*T(40+40*j)));
f(3)=4*T(40+40*j)*exp(-10000*4.18/(8.314*T(40+40*j)));
f(5)=(10^10)*exp(-31000*4.18/(8.314*T(40+40*j)));
f(6)=3*(10^9)*exp(-32000*4.18/(8.314*T(40+40*j)));
f(7)=0.15*T(40+40*j)*exp(-8000*4.18/(8.314*T(40+40*j)));
f(8)=3*T(40+40*j)*exp(-11000*4.18/(8.314*T(40+40*j)));
f(9)=(10^10)*exp(-33000*4.18/(8.314*T(40+40*j)));
f(10)=4*(10^15)*exp(-48500*4.18/(8.314*T(40+40*j)));
f(11)=2*(10^13)*exp(-37500*4.18/(8.314*T(40+40*j)));
f(12)=(10^9)*exp(-25500*4.18/(8.314*T(40+40*j)));
f(13)=5*(10^6)*exp(-31500*4.18/(8.314*T(40+40*j)));
f(14)=3*(10^8)*exp(-30000*4.18/(8.314*T(40+40*j)));
f(15)=(10^2)*exp(-15000*4.18/(8.314*T(40+40*j)));
f(16)=8*T(40+40*j)*exp(-12000*4.18/(8.314*T(40+40*j)));
f(17)=1.2*(10^9)*exp(-30000*4.18/(8.314*T(40+40*j)));
f(18)=0.25*T(40+40*j)*exp(-8000*4.18/(8.314*T(40+40*j)));
f(19)=6*(10^5)*exp(-24000*4.18/(8.314*T(40+40*j)));
f(20)=5*(10^11)*exp(-50000*4.18/(8.314*T(40+40*j)));
f(21)=5*(10^11)*exp(-71000*4.18/(8.314*T(40+40*j)));
f(22)=5*(10^11)*exp(-75000*4.18/(8.314*T(40+40*j)));
f(23)=5*(10^12)*exp(-50000*4.18/(8.314*T(40+40*j)));

% rho = T(40*j + 1) + T(40*j+2)+ T(40*j+3)+ T(40*j+4)+ T(40*j+5)+ T(40*j+6)+ T(40*j+7)+ T(40*j+8)+ T(40*j+9)+ T(40*j+10)+ T(40*j+11) + T(40*j+18);
dT(40) = (1/rho*Cp*dVol)*(-h*A*(T(40+40*j) - T(80)) - 0.5*sigma*e*(2*T(40)^4 - T(80)^4 - 1200^4) + (heat*f)/1);

%keyboard
end
